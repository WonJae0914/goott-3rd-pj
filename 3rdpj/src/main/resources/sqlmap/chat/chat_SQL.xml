<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chat">
    <!--    <insert id="create" parameterType="com.goott.pj3.common.util.chat.ChatRoomDTO"-->
    <!--    useGeneratedKeys="true" keyProperty="msg_idx">-->
    <!--        INSERT INTO msg(send_id, receive_id, msg_img, msg_content)-->
    <!--        VALUES (#{send_id}, #{receive_id}, '', '')-->
    <!--    </insert>-->
    <insert id="create" parameterType="com.goott.pj3.common.util.chat.ChatRoomDTO"
            useGeneratedKeys="true" keyProperty="msg_idx">
        INSERT INTO msg (send_id, receive_id, msg_img, msg_content)
        SELECT #{send_id}, #{receive_id}, '', ''
        FROM DUAL
        WHERE NOT #{send_id} = #{receive_id}
          AND NOT EXISTS (SELECT msg_idx
                          FROM msg
                          WHERE (send_id = #{send_id} AND receive_id = #{receive_id})
                             OR (send_id = #{receive_id} AND receive_id = #{send_id}))
    </insert>
    <select id="findRoomById" resultType="com.goott.pj3.common.util.chat.ChatRoomDTO">
        SELECT msg_idx, send_id, receive_id, read_yn, create_date
        FROM msg
        WHERE msg_idx = #{msg_idx}
    </select>
    <select id="findAllRooms" resultType="com.goott.pj3.common.util.chat.ChatRoomDTO">
        SELECT msg_idx, send_id, receive_id, read_yn, msg_img, msg_content, create_date
        FROM msg
        WHERE send_id = #{user_id}
           OR receive_id = #{user_id}
        ORDER BY msg_idx DESC
    </select>
    <select id="findRoomByName" resultType="com.goott.pj3.common.util.chat.ChatRoomDTO">
        SELECT msg_idx, send_id, receive_id
        FROM msg
        WHERE (send_id = #{send_id} AND receive_id = #{receive_id})
           OR (send_id = #{receive_id} AND receive_id = #{send_id})
    </select>

</mapper>
